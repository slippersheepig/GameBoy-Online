<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>GameBoyColor</title>
  <link rel="icon" type="image/png" href="/images/128.png">
  <link rel="stylesheet" href="/css/GameBoy.css">
  <script>
    var DEBUG_MESSAGES = false;
    var DEBUG_WINDOWING = false;
    window.onload = function () {
      windowingInitialize();
    }
  </script>
  <script src="js/other/windowStack.js"></script>
  <script src="js/other/terminal.js"></script>
  <script src="js/other/gui.js"></script>
  <script src="js/other/base64.js"></script>
  <script src="js/other/json2.js"></script>
  <script src="js/other/swfobject.js"></script>
  <script src="js/other/resampler.js"></script>
  <script src="js/other/XAudioServer.js"></script>
  <script src="js/other/resize.js"></script>
  <script src="js/GameBoyCore.js"></script>
  <script src="js/GameBoyIO.js"></script>
</head>
<body>
  <div id="GameBoy" class="window">
    <div class="menubar">
      <span id="GameBoy_file_menu">文件</span>
      <span id="GameBoy_settings_menu">设置</span>
      <span id="GameBoy_view_menu">视图</span>
      <span id="GameBoy_about_menu">关于</span>
    </div>
    <div id="gfx">
      <canvas id="mainCanvas"></canvas>
      <span id="title">GameBoy</span>
      <span id="port_title">Online</span>
    </div>
  </div>
    <div id="gb-virtual-controls" class="gb-controls" aria-hidden="false">
      <div class="gb-controls-inner">
        <div class="gb-controls-row">
          <div class="gb-dpad" role="group" aria-label="D-Pad">
            <button id="gb-btn-up"    class="gb-btn gb-dpad-up"    aria-label="Up">▲</button>
            <button id="gb-btn-left"  class="gb-btn gb-dpad-left"  aria-label="Left">◄</button>
            <button id="gb-btn-right" class="gb-btn gb-dpad-right" aria-label="Right">►</button>
            <button id="gb-btn-down"  class="gb-btn gb-dpad-down"  aria-label="Down">▼</button>
          </div>
          <div class="gb-ab" role="group" aria-label="Action Buttons">
            <button id="gb-btn-b" class="gb-btn gb-b" aria-label="B">B</button>
            <button id="gb-btn-a" class="gb-btn gb-a" aria-label="A">A</button>
          </div>
        </div>
        <div class="gb-select-start" role="group" aria-label="Select Start">
          <button id="gb-btn-select" class="gb-btn gb-select" aria-label="Select">SELECT</button>
          <button id="gb-btn-start"  class="gb-btn gb-start"  aria-label="Start">START</button>
        </div>
      </div>
    </div>
        <div id="terminal" class="window">
            <div id="terminal_output"></div>
            <div class="button_rack">
                <button id="terminal_clear_button" class="left">清除消息</button>
                <button id="terminal_close_button" class="right">关闭终端</button>
            </div>
        </div>
        <div id="about" class="window">
            <div id="about_message">
                <h1>GameBoy Online</h1>
                <p>这是由Grant Galitz使用纯JavaScript编写的GameBoy Color模拟器。</p><p>图形通过HTML5 Canvas的putImageData和drawImage函数进行渲染。</p><p>存档通过window.localStorage实现；若需更大的存储空间，请调整浏览器的本地存储配额以满足模拟器存档数据的需求。</p><p>有关此模拟器及其源码的更多信息，请访问Git仓库：<a href="https://github.com/taisel/GameBoy-Online" target="_blank">https://github.com/taisel/GameBoy-Online</a>。
                </p>
            </div>
            <div class="button_rack">
                <button id="about_close_button" class="center">关闭弹窗</button>
            </div>
        </div>
        <div class="window" id="settings">
            <div id="toggle_settings">
                <div class="setting">
                    <span>启用声音：</span>
                    <input type="checkbox" checked="checked" id="enable_sound"/>
                </div>
                <div class="setting">
                    <span>GB模式优先于GBC模式：</span>
                    <input type="checkbox" id="disable_colors"/>
                </div>
                <div class="setting">
                    <span>使用BIOS ROM：</span>
                    <input type="checkbox" checked="checked" id="enable_gbc_bios"/>
                </div>
                <div class="setting">
                    <span>将仅含ROM的卡带类型覆盖为MBC1：</span>
                    <input type="checkbox" checked="checked" id="rom_only_override"/>
                </div>
                <div class="setting">
                    <span>始终允许对MBC记忆库进行读写：</span>
                    <input type="checkbox" checked="checked" id="mbc_enable_override"/>
                </div>
                <div class="setting">
                    <span>为经典GameBoy调色板着色：</span>
                    <input type="checkbox" checked="checked" id="enable_colorization"/>
                </div>
                <div class="setting">
                    <span>全屏时使用最小化视图：</span>
                    <input type="checkbox" checked="checked" id="do_minimal"/>
                </div>
                <div class="setting">
                    <span>在JavaScript中直接调整画布大小：</span>
                    <input type="checkbox" id="software_resizing"/>
                </div>
                <div class="setting">
                    <span>禁止使用typed arrays：</span>
                    <input type="checkbox" id="typed_arrays_disallow"/>
                </div>
                <div class="setting">
                    <span>使用DMG启动ROM而不是CGB：</span>
                    <input type="checkbox" id="gb_boot_rom_utilized"/>
                </div>
                <div class="setting">
                    <span>在调整画布大小时启用平滑：</span>
                    <input type="checkbox" checked="checked" id="resize_smoothing"/>
                </div>
                <div class="setting">
                    <span>启用声道1：</span>
                    <input type="checkbox" checked="checked" id="channel1"/>
                </div>
                <div class="setting">
                    <span>启用声道2：</span>
                    <input type="checkbox" checked="checked" id="channel2"/>
                </div>
                <div class="setting">
                    <span>启用声道3：</span>
                    <input type="checkbox" checked="checked" id="channel3"/>
                </div>
                <div class="setting">
                    <span>启用声道4：</span>
                    <input type="checkbox" checked="checked" id="channel4"/>
                </div>
            </div>
            <div class="button_rack">
                <button id="settings_close_button" class="center">关闭设置</button>
            </div>
        </div>
        <div id="instructions" class="window">
            <div id="keycodes">
                <h1>键盘控制：</h1>
                <ul>
                    <li>键盘X/J对应GBC的A按钮。</li>
                    <li>键盘Z/Y/Q对应GBC的B按钮。</li>
                    <li>键盘Shift对应GBC的Select按钮。</li>
                    <li>键盘Enter（回车）对应GBC的Start按钮。</li>
                    <li>使用键盘方向键控制方向。</li>
                    <li>使用键盘左上角退出键 (Esc) 可以进入或退出全屏模式。</li>
                </ul>
            </div>
            <div class="button_rack">
                <button id="instructions_close_button" class="center">关闭说明</button>
            </div>
        </div>
        <div id="input_select" class="window">
            <form>
                <input type="file" id="local_file_open"/>
            </form>
            <div class="button_rack">
                <button id="input_select_close_button" class="center">关闭文件输入</button>
            </div>
        </div>
        <div id="save_importer" class="window">
            <form>
                <input type="file" id="save_open"/>
            </form>
            <div class="button_rack">
                <button id="save_importer_close_button" class="center">关闭存档导入</button>
            </div>
        </div>
        <div class="window" id="local_storage_listing">
            <div id="storageListingMasterContainer" class="storageList">
                <div id="storageListingMasterContainerSub"></div>
            </div>
            <div id="download_all_storage">
                <a href="about:blank" id="download_local_storage_dba">导出所有存档。</a>
            </div>
            <div class="button_rack">
                <button id="local_storage_list_refresh_button" class="left">刷新列表</button>
                <button id="local_storage_list_close_button" class="right">关闭存储列表</button>
            </div>
        </div>
        <div class="window" id="local_storage_popup">
            <div id="storagePopupMasterParent" class="storageList">
                <div id="storagePopupMasterContainer"></div>
            </div>
            <div class="button_rack">
                <button id="local_storage_popup_close_button" class="center">关闭存储弹窗</button>
            </div>
        </div>
        <div class="window" id="freeze_listing">
            <div id="freezeListingMasterContainer" class="storageList">
                <div id="freezeListingMasterContainerSub"></div>
            </div>
            <div class="button_rack">
                <button id="freeze_list_refresh_button" class="left">刷新列表</button>
                <button id="freeze_list_close_button" class="right">关闭冻结状态列表</button>
            </div>
        </div>
        <ul class="menu" id="GameBoy_file_popup">
            <li>打开...<ul class="menu">
                <li id="data_uri_clicker">Base64加密文件</li>
                <li id="internal_file_clicker">本地文件</li>
            </ul></li>
            <li id="save_SRAM_state_clicker">保存到记忆体</li>
            <li id="save_state_clicker">保存冻结状态</li>
            <li id="set_volume">设置音量</li>
            <li id="set_speed">设置速度</li>
            <li id="restart_cpu_clicker">重启</li>
            <li id="run_cpu_clicker">恢复</li>
            <li id="kill_cpu_clicker">暂停</li>
        </ul>
        <ul class="menu" id="GameBoy_view_popup">
            <li id="view_terminal">终端</li>
            <li id="view_instructions">说明</li>
            <li id="view_importer">存档导入</li>
            <li id="local_storage_list_menu">记忆体管理</li>
            <li id="freeze_list_menu">冻结状态管理</li>
            <li id="view_fullscreen">全屏模式</li>
        </ul>
        <div id="fullscreenContainer">
            <canvas id="fullscreen" class="maximum"></canvas>
        </div>
      <script src="js/other/onscreen-controls.js"></script>

<script>
(function(){
  var game = document.getElementById('GameBoy');
  var controls = document.getElementById('gb-virtual-controls');
  if (!game || !controls) return;
  var lastRect = null;
  function applyPos(rect){
    var left = Math.round(rect.left + (window.pageXOffset || document.documentElement.scrollLeft || 0));
    var top  = Math.round(rect.bottom + (window.pageYOffset || document.documentElement.scrollTop || 0) + 8);
    var targetWidth = Math.min(Math.max(Math.round(rect.width), 220), 520);
    controls.style.setProperty('position', 'absolute', 'important');
    controls.style.setProperty('left', left + 'px', 'important');
    controls.style.setProperty('top',  top  + 'px', 'important');
    controls.style.setProperty('width', targetWidth + 'px', 'important');
    controls.style.setProperty('max-width', targetWidth + 'px', 'important');
    controls.style.setProperty('display', 'block', 'important');
    controls.style.setProperty('transform', 'none', 'important');
    controls.style.setProperty('z-index', '10001', 'important');
  }
  function updateIfNeeded(){
    var r = game.getBoundingClientRect();
    if (r.width === 0 && r.height === 0) {
      controls.style.setProperty('display', 'none', 'important');
      lastRect = null;
      return;
    }
    if (!lastRect ||
        r.left !== lastRect.left ||
        r.top !== lastRect.top ||
        r.width !== lastRect.width ||
        r.height !== lastRect.height ||
        r.bottom !== lastRect.bottom) {
      applyPos(r);
      lastRect = { left: r.left, top: r.top, width: r.width, height: r.height, bottom: r.bottom };
    }
  }
  if (window.ResizeObserver) {
    try {
      var ro = new ResizeObserver(function(){ updateIfNeeded(); });
      ro.observe(game);
    } catch(e){}
  }
  try {
    var ctrlObserver = new MutationObserver(function(muts){
      for (var i=0;i<muts.length;i++){
        var m = muts[i];
        if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')) {
          setTimeout(updateIfNeeded, 0);
          break;
        }
      }
    });
    ctrlObserver.observe(controls, { attributes: true, attributeFilter: ['style','class'] });
    var bodyObserver = new MutationObserver(function(){ setTimeout(updateIfNeeded, 0); });
    bodyObserver.observe(document.body, { attributes: true, childList: true, subtree: true });
  } catch(e){}
  window.addEventListener('load', function(){ setTimeout(updateIfNeeded, 20); });
  window.addEventListener('resize', function(){ updateIfNeeded(); });
  window.addEventListener('scroll', function(){ updateIfNeeded(); });
  var checks = 0;
  var poll = setInterval(function(){
    updateIfNeeded();
    checks++;
    if (checks > 15) clearInterval(poll);
  }, 200);
  updateIfNeeded();
  setTimeout(updateIfNeeded, 60);
  setTimeout(updateIfNeeded, 200);
  setTimeout(updateIfNeeded, 800);
})();
</script>
</body>
</html>
